##### Table of contents

1. [工程命名规范](#1)
2. [Maven 使用约定](#2)
3. [工程依赖管理](#3)
4. [工程包名规范](#4)
5. [类名约定](#5)
6. [方法约定](#6)
7. [Spring 使用约定](#7)
8. [JPA 使用约定](#8)



# 约定与规范

SkyEngine 的核心是为系统组件化开发提供基础骨架，基于 **约定优于配置** 的理念，要使用 SkyEngine 进行组件化开发，需要遵循框架制定的一些约定。

同时为了统一开发人员的代码风格，提高代码的可维护性，SkyEngine 会对代码规范进行静态扫描，请遵循本文中的约定和规范进行使用。



## 1. 工程命名规范<a name='1'></a>

> 以下描述中 `{ }` 中的内容为占位符，表示等同与第一个的内容。

### 1.1 子系统工程

- 子系统**父工程**：`{subSystemName}`，推荐全小写。例如：`rccp`
- 子系统**后端**开发工程：`{subSystemName}-backend-develop`
- 子系统**前端**开发工程：`{subSystemName}-frontend`
- 子系统后端**部署工程**：`{subSystemName}-backend-deploy`

子系统工程结构如下示例：

```bash
rccp
  |—— rccp-backend-develop
  |—— rccp-baclend-deploy
  |—— rccp-frontend
```



### 1.2 组件工程

> 以下描述中 `{subSystemName}` 为子系统名称，特殊的`{subSystemName}` **cbb-** 和 **base-** 组件为基础组件，可以部署到不同子系统中。

- 组件父工程：`{subSystemName}-{moduleName}-module`。例如：`base-aaa-module` 或 `rcdc-user-module`
- 组件定义工程：`{subSystemName}-{moduleName}-module-def`。这个子工程主要定义对外发布的接口，例如：`base-aaa-module-def`
- 组件实现工程：`{subSystemName}-{moduleName}-module-impl`。业务的实现在这个子工程内，例如：`base-aaa-module-impl`
- 组件WEB工程：`{subSystemName}-{moduleName}-module-web`。业务提供的Restful接口在这个子工程内，例如：`base-aaa-module-web`
- 组件部署工程：`{subSystemName}-{moduleName}-module-deploy`。单独对组件进行部署时添加此工程，主要放一些配置文件。例如：`base-aaa-module-deploy`

组件工程结构如下示例：

```bash
base-aaa-module
	|—— base-aaa-module-def
	|—— base-aaa-module-impl
	|—— base-aaa-module-web
	|—— base-aaa-module-deploy
```



## 2. Maven 使用约定<a name='2'></a>

Maven 的使用约定包括了 `groupId` 和文件目录的划分。

### 2.1 groupId 命名约定

groupId 保持和父工程相同并将 `-` 替换为 `.`，且以 `com.ruijie.rcos` 为统一前缀。

- 子系统：`com.ruijie.rcos.{subSystemName}`
- 组件：`com.ruijie.rcos.{subSystemName}.{moduleName}.module`



### 2.2 version 版本号

开发版本使用默认的 **SNAPSHOT** ，转测后改为相应的 **RELEASE** 版本。



### 2.3 目录划分

按照默认的 Maven 目录划分，系统参数配置 和 Spring 的配置文件放到相应的目录中。对应的目录及命名说明：

- `/src/main/java`：源码目录
- `/src/main/resources`：配置文件目录，放通用配置
- `/src/main/resources/config`：包含所有开发环境用的配置参数
- `/src/main/resources/spring`：目录下包含 **子系统** 自定义的 Spring 配置
- `/src/main/resources/spring-mvc`：**子系统** 自定义的 SpringMVC 配置
- `/src/main/resources/spring-module`：**子系统** 对依赖的组件特殊配置 和 **组件** 初始化相关的私有 Spring 配置
- `/src/main/resources/i18N/messages_zh_CN.properties`：国际化内容
- `/src/main/resources/sql-script`：组件或子系统的数据库脚本存档
- `/src/main/webapp/WEB-INF`：进行部署时 web servlet 的相关配置
- `/test/java`：单元测试代码
- `/test/resources`：单元测试需要的配置，配置文件的目录结构参照上述

划分目录时需要注意 **区分子系统和组件**，还需要 **区子工程的功能**。例如：定义工程 `-def` 不应该包含配置，而配置均放到实现工程 `-impl` 中。具体的目录示例如下：

```bash
/src
  |—— main
  	   |—— java
  	   |—— resources
  	   		 |—— log4j2.xml
  	   		 |—— config
  	   		 		|—— config.properties
  	   		 |—— i18N
  	   		 		|—— messages_zh_CN.properties
  	   		 |—— spring
  	   		 |—— spring-mvc
  	   		 |—— spring-module
  	   		 |—— sql-script
  	  |—— webapp
  	   		 |—— WEB-INF
  |—— test
  	   |—— java
  	   |—— resources
```





## 3. 工程依赖管理<a name='3'></a>

### 3.1 子系统依赖

#### 3.1.1 子系统父工程依赖<a id='3.1.1'></a>

子系统父工程 POM 使用继承方式引入 SkyEngine 框架的依赖，以及单元测试与其它第三方库。并在父工程中维护每个关联组件的版本号。

POM 示例如下：

```xml
<parent>
    <groupId>com.ruijie.rcos.sk.root</groupId>
    <artifactId>sk-root-api</artifactId>
    <version>2.0.0-SNAPSHOT</version>
</parent>
<packaging>pom</packaging>
<properties>
    <base-aaa-module.version>0.0.1-SNAPSHOT</base-aaa-module.version>
</properties>
```



#### 3.1.2 子系统后端工程依赖

子系统后端工程 POM 中引入使用到的组件的 **定义工程(def)** ，仅通过接口方式调用组件服务。

POM 示例如下：

```xml
<packaging>jar</packaging>
<dependencies>
    <dependency>
        <groupId>com.ruijie.rcos.base.alarm.module</groupId>
        <artifactId>base-alarm-module-def</artifactId>
        <version>${project.version}</version>
    </dependency>
</dependencies>
```



#### 3.1.3 子系统部署工程依赖<a id='3.1.3'></a>

子系统部署工程依赖 SkyEngine 框架的 **runtime** 包，提供 Servlet 上下文。 POM 中引入使用到的组件的 **实现工程(impl)** 和 组件的 **web工程**，不包括任何业务实现，仅用于打包部署，POM 类型为 war。

POM 示例如下：

```xml
<packaging>war</packaging>
<dependencies>
    <dependency>
        <groupId>com.ruijie.rcos.sk.root</groupId>
        <artifactId>sk-root-runtime</artifactId>
        <version>${skyengine.version}</version>
        <scope>runtime</scope>
    </dependency>

    <dependency>
        <groupId>com.ruijie.rcos.base.aaa.module</groupId>
        <artifactId>base-aaa-module-impl</artifactId>
        <version>${base-aaa-module.version}</version>
    </dependency>
    <dependency>
        <groupId>com.ruijie.rcos.base.aaa.module</groupId>
        <artifactId>base-aaa-module-web</artifactId>
        <version>${base-aaa-module.version}</version>
    </dependency>
</dependencies>
```



#### 3.1.4 子系统前端工程依赖

目前已完全采用前后端分离的开发模式，前端工程已非必需。



### 3.2 组件依赖

组件的依赖与子系统相似，其实子系统可看作一个整合了多个组件特殊的组件。

#### 3.2.1 组件父工程依赖

继承 SkyEngine 框架依赖，以及单元测试与其它第三方库。同 [3.1.1 子系统父工程依赖](#3.1.1)。



#### 3.2.2 组件定义工程依赖

组件定义工程仅用于定义 **API** 和 **交互数据模型** ，不依赖其它库。



#### 3.2.3 组件实现工程依赖

组件实现工程首先要依赖本组件的定义工程， 如果还使用了其它组件，则也需要引入其它组件定义工程。

示例如下：

```xml
<packaging>jar</packaging>
<dependencies>
    <!-- 本组件的定义工程 -->
    <dependency>
        <groupId>com.ruijie.rcos.base.alarm.module</groupId>
        <artifactId>base-alarm-module-def</artifactId>
        <version>${project.version}</version>
    </dependency>

    <!-- aaa组件的定义工程 -->
    <dependency>
        <groupId>com.ruijie.rcos.base.aaa.module</groupId>
        <artifactId>base-aaa-module-def</artifactId>
        <version>${base-aaa-module.version}</version>
    </dependency>
</dependencies>
```



#### 3.2.4 组件WEB工程依赖

组件web工程主要为组件提供 Restful 接口，提供可测试联调的开放接口，这一工程也是非必需的。

组件web工程依赖 **组件的定义工程**，通过接口使用组件提供的服务。



#### 3.2.5 组件部署工程依赖

组件的部署工程是为了单独部署组件时使用，单独部署组件以便通过 Restful 方式测试联调组件的接口，这一工程也是非必需的。

组件的部署工程与子系统部署工程相同，通过引入 **组件实现** 和 **组件web** 使用组件，以及依赖 SkyEngine runtime 提供 Servlet 上下文。

具体示例参考 [3.1.3 子系统部署工程依赖](#3.1.3)



## 4. 工程包名规范<a name='4'></a>

### 4.1 子系统后端工程

子系统工程中，仅在 `{subSystemName}-backend-develop` 后端开发工程中有业务代码，其余子工程仅有配置信息。理想情况下子系统应该由一系列的组件组合而成，自身不包括业务代码。

后端开发工程包结构如下：

- `com.ruijie.rcos.{subSystemName}`：**根包**，仅包含国际化定义接口 BusinessKey
- `{根包}.ctrl`：Controller 层包含所有 WEB API 定义和实现
- `{根包}.request`：WEB 请求参数模型，可根据业务在包内再细分
- `{根包}.response`：WEB 响应参数模型，可根据业务在包内再细分
- `{根包}.model`：子系统业务用到的数据模型
- `{根包}.service`：子系统自身业务实现
- `{根包}.dao`：子系统自身数据持久层
- `{根包}.entity`：子系统自身的数据库实体



### 4.2 组件定义工程

组件定义工程主要职责是对外提供使用，主要定义接口、交互数据模型、提供的服务等。

组件定义工程包结构如下：

- `com.ruijie.rcos.{subSystemName}.{moduleName}.module.def`：**根包**，不包含任何类
- `{根包}.api`：API 定义包，直接在此包下定义接口
- `{根包}.spi`：SPI 定义包
- `{根包}.api.request`：API 接口请求参数，可以根据业务模块在此包下再细分
- `{根包}.api.response`：API 接口响应参数，可以根据业务模块在此包下再细分
- `{根包}.dto`：API 接口用到的业务嵌套数据结构
- `{根包}.enums`：API 接口相关的枚举
- `{根包}.msg`：对外暴露的消息队列和配置信息
- `{根包}.interceptor`：组件公开的拦截器
- `{根包}.constant`：API 接口相关的常量定义
- `{根包}.wrapper`：组件 API 的封装
- `{根包}.annotation`：业务处理时可能用到注解



### 4.3 组件实现工程

组件实现工程职责是业务的具体实现，具体的包结构如下：

- `com.ruijie.rcos.{subSystemName}.{module}.module.impl`：**根包**，仅包含国际化定义接口 BusinessKey
- `{根包}.api`：组件接口的实现
- `{根包}.dao`：数据持久层 DAO
- `{根包}.entity`：数据库实体映射
- `{根包}.dto`：内部用的复杂业务数据模型
- `{根包}.service`：具体的业务逻辑实现
- `{根包}.msg`：间接通信的消息监听，如通过消息队列的订阅
- `{根包}.quartz`：通过 Quartz 执行的定时任务
- `{根包}.task`：自定义的异步任务
- `{根包}.tx`：包含本地事务的业务
- `{根包}.constant`：常量定义
- `{根包}.util`：辅助工具类



### 4.4 组件WEB工程

组件 Web 工程职责是封装组件 API 接口，对外提供可通过 Restful 请求的接口，具体的包结构如下：

- `com.ruijie.rcos.{subSystemName}.{moduleName}.module.web`：**根包**，仅包含国际化定义接口 BusinessKey
- `{根包}.ctrl`：Controller 层，定义 Restful 接口
- `{根包}.request`：Restful 接口请求参数，可以根据业务模块在此包下再细分
- `{根包}.validation`：请求参数校验类
- `{根包}.vo`：Restful 接口响应嵌套实体



## 5. 类名约定<a name='5'></a>

这部分是对业务开发过程中对类进行命名的约定，通过统一的命名风格，提高代码的可读性和可维护性。

### 5.1 通用命名规范

- 首字母大写，以驼峰命名方式。不以 `_` 或 `$` 结尾
- 严禁使用英文和拼音混合使用的方式，全拼音方式也要尽量避免
- 抽象类以 `Abstract` 开头
- 接口不加 `I` 前缀，接口的实现类以接口名加 `Impl` 结尾
- 内部用的复杂业务数据模型以 `DTO` 结尾
- Restful 接口响应嵌套实体以 `VO` 结尾
- 以相应功能名做为结尾，例如：`Interceptor`、`Task`、`Quartz`、`Exception`、`Test`、`Util`



### 5.2 组件定义工程相关

- 组件定义接口以 `API` 结尾
- 组件定义接口请求参数以 `Request` 结尾，且实现 `com.ruijie.rcos.sk.modulekit.api.comm.Request` 接口
- 组件定义接口响应参数以 `Response` 结尾，且继承 `com.ruijie.rcos.sk.modulekit.api.comm.DefaultResponse` 类



### 5.3 组件实现工程相关

- 数据持久层接口以 `DAO` 结尾，且继承 `SkyEngineJpaRepository` 接口
- 数据库实体对象以 `Entity` 结尾
- 业务逻辑实现接口以 `Service` 结尾
- 包含本地事务的业务接口以 `Tx` 结尾
- 常量定义类以 `Constants` 结尾
- 国际化 Key 接口文件统一命名为 `BusinessKey`，存放在对应根包下



### 5.4 组件WEB工程相关

- Controller 层类以 `Controller` 结尾
- Controller 层参数验证以 `Validation` 结尾



## 6. 方法约定<a name='6'></a>

这部分是对业务开发过程中方法的命名以及部分参数的约定，通过统一的命名风格，提高代码的可读性和可维护性。

### 6.1 命名规范

- 方法名以小写字母开头，驼峰命名方式，不以 `_` 或 `$` 结尾
- 布尔返回值的方法以`is`、`has`、`can`、`should` 或能明确表达返回值的为名。例如：`needTranslate`
- 获得单个对象建议以 `get` 做前缀
- 获得多个对象建议以 `list` 做前缀
- 进行统计值的建议以 `count` 做前缀
- 插入的方法建议用 `save` 或 `insert` 做前缀
- 修改的方法建议用 `update` 做前缀
- 删除的方法建议用 `remove` 或 `delete` 做前缀
- 事务补偿方法以 `rollback` 做前缀，完整名为 `rollback+具体业务方法`



### 6.2 参数约定

这部分是关于方法参数类型的约定，需要注意如下：

- API 和 SPI 接口定义的参数需实现 `com.ruijie.rcos.sk.modulekit.api.comm.Request` 接口
- API 接口定义的 **分页查询** 请求参数需继承 `DefaultPageRequest`
- API 接口定义的 **返回值** 需继承  `com.ruijie.rcos.sk.modulekit.api.comm.DefaultResponse` 类
- API 接口定义的 **分页列表** 返回类型使用 `DefaultPageResponse<dto>`
- API 接口定义使用 `@Rollback`、`@NoRollback` 标注失败后是否需要事务补偿
- Controller 层接口请求参数必须实现 `com.ruijie.rcos.sk.webmvc.api.request.WebRequest` 接口
- Controller 层接口的列表 **分页查询** 参数需继承 `PageWebRequest`
- Controller 层接口的请求类型为 `@RequestMapping(method=POST)`
- Controller 层接口的返回值为 `DefaultWebResponse`



## 7. Spring 使用约定<a name='7'></a>

这部分是在使用 Spring Bean 时需要注意的，具体如下：

- 全局生效的配置信息，放到 `/resources/spring` 或 `/resource/spring-module/` 下的配置文件中
- 业务服务类使用 `@Service` 注解标注
- 数据持久层不需要注解
- 使用 `@Autowired`、`@Qualifier`、`@Inject` 等注入  Bean 



## 8. JPA 使用约定<a name='8'></a>

这部分是关于使用 JPA 做为数据持久层时需要注意的几个点，包括继承、命名、数据库实体等。

JPA 使用约定如下：

- 业务表必须带有 `version int` 字段，用于实现乐观锁
- 表实体统一以 `Entity` 结尾，并加上 `@Table` 注解对应具体业务表
- 主键使用 `UUID` 类型
- 使用 `@Version` 标注 version 字段，JPA 支持乐观锁实现
- DAO 为接口类型，需要实现接口 `SkyEngineJpaRepository<entity, idType>`
- DAO 中更新记录时，使用 `version` 进行乐观锁控制。例如：`@Query("update entity set c1=?2, version=version+1 where id=?1 and version=?3")`

